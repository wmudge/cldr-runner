---

# kitchen sink

version: 1

build_arg_defaults:
  EE_BASE_IMAGE: "quay.io/ansible/ansible-runner:stable-2.12-latest"
  EE_BUILDER_IMAGE: "cloudera.com/ansible/ansible-builder:${BUILD_TAG:-latest}"

#ansible_config: 'ansible.cfg'

dependencies:
  galaxy: payload/deps/ansible.yml
  python: payload/deps/python_base.txt
  system: ee-bindep.txt

additional_build_steps:
  prepend: |
    ENV CLDR_BUILD_VER=${BUILD_TAG:-latest}
    COPY . /tmp/src
    RUN mv /tmp/src/bashrc /home/runner/.bashrc
    RUN mv /tmp/src/repos/*.repo /etc/yum.repos.d/
    RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc
    RUN dnf install -y terraform kubectl
    RUN dnf clean expire-cache
    RUN /usr/bin/python3 -m pip install --upgrade pip
  append: |
    RUN echo "Purging Pip cache" && pip cache purge || echo "No Pip cache to purge"
    RUN echo "Cleaning dnf/yum cache" && dnf clean all
    RUN rm -rf /var/cache/yum
    RUN rm -rf /var/cache/dnf
